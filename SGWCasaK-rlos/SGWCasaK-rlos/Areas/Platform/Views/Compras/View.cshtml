@model Core.DTOs.Compras.ComprasAddViewModel
<div class="m-content" style="width: 100%">
	<div class="row">
		<div class="col-md-12">
			<div class="m-portlet m-portlet--tab">
				<div class="m-portlet__head">
					<div class="row">
						<div class="col-md-6 col-sm-4">
							<div class="m-portlet__head-caption">
								<div class="m-portlet__head-title" style="margin-top: 20px;">
									<h3 class="m-portlet__head-text">
										Ver Compra
									</h3>
								</div>
							</div>
						</div>
						
					</div>

				</div>
				<!--begin::Form-->
				<form class="m-form m-form--fit m-form--label-align-right">
					<div class="m-portlet__body">
						<div class="row" style="margin-bottom: 20px;">
							<div class="col-md-7">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-1 col-form-label" style="text-align: left">
										Fecha
									</label>
									<div class="col-3">
										<input class="form-control m-input datepicker" style="width: 100%" type="text" id="example-text-input" data-bind="datepicker: dateCompra, datepickerOptions: {language: 'es'}" disabled>
									</div>
									<label for="example-text-input" class="col-2 col-form-label" style="text-align: left">
										Nro Factura
									</label>
									<div class="col-6">
										<input class="form-control m-input" style="width: 100%" type="text" id="example-text-input" data-bind="value: nroFactura" readonly>
									</div>
								</div>
							</div>
							<div class="col-md-5">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label" style="text-align: left">
										Condicion Compra
									</label>
									<div class="col-8">
										<select class="form-control m-input m-input--square" id="condicionCompraSelect" data-bind="options: condicionesCompra,
                                           optionsValue: 'value',
                                           optionsText: 'text',
                                           value: condicionCompra,
                                           optionsCaption: 'Seleccione una opcion'" disabled></select>
									</div>
								</div>
							</div>
						</div>
						<div class="row" style="margin-bottom: 20px;">
							<div class="col-md-6">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-2 col-form-label" style="text-align: left">
										Ruc
									</label>
									<div class="col-6">
										<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.proveedor.ruc" readonly>
									</div>

								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label" style="text-align: left">
										Nombre o Razon Social
									</label>
									<div class="col-8">
										<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.proveedor.displayName" readonly>
									</div>
								</div>
							</div>
						</div>
						<div class="row" style="margin-bottom: 20px;">
							<div class="col-md-7">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-1 col-form-label" style="text-align: left">
										Fecha Incio
									</label>
									<div class="col-3">
										<input class="form-control m-input datepicker" style="width: 100%" type="text" id="example-text-input" data-bind="datepicker: fechaInicio, datepickerOptions: {language: 'es'}" disabled>
									</div>
									<label for="example-text-input" class="col-1 col-form-label" style="text-align: left">
										Fecha Incio
									</label>
									<div class="col-3">
										<input class="form-control m-input datepicker" style="width: 100%" type="text" id="example-text-input" data-bind="datepicker: fechaFin, datepickerOptions: {language: 'es'}" disabled>
									</div>
								</div>
							</div>
							<div class="col-md-5">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label" style="text-align: left">
										Nro Timbrado
									</label>
									<div class="col-8">
										<input class="form-control m-input" style="width: 100%" type="text" id="example-text-input" data-bind="value: timbrado" readonly>
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="m-portlet m-portlet--tab">
				<div class="m-portlet__head">
					<div class="m-portlet__head-caption">
						<div class="m-portlet__head-title">
							<h3 class="m-portlet__head-text">
								Detalle
							</h3>
						</div>
					</div>
				</div>

				<div class="m-portlet__body">
					<!--begin: Datatable -->
					<table id="detalleAddCompraTable" class="table m-table m-table--head-bg-success">
						<thead>
							<tr>
								<th>
									Cant
								</th>
								<th>
									Descripcion
								</th>
								<th>
									Precio Compra
								</th>
								<th style=" text-align : center">
									Total
								</th>
							</tr>
						</thead>
						<tbody data-bind="foreach: detalleCompra">
							<tr>
								<td data-bind="text: cantidad"></td>
								<td data-bind="text: nombre"></td>
								<td data-bind="text: precioCompra"></td>
								<td data-bind="text: montoTotal"></td>
							</tr>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="3" style="text-align : center">Monto Total </td>
								<td data-bind="text: montoTotal"></td>
							</tr>
						</tfoot>
					</table>
					<!--end: Datatable -->
				</div>
			</div>
			<div class="m-portlet m-portlet--tab">

				<!--begin::Form-->
				<form class="m-form m-form--fit m-form--label-align-right" id="productoAddDetalleForm">
					<div class="m-portlet__body">
						<div class="row">
							<div class="col-md-3">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-12 col-form-label">
										Total Iva
									</label>

								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label">
										IVA Cinco
									</label>
									<div class="col-8">
										<input class="form-control m-input" type="text" id="productoPrecioCompra" data-bind="value: dataViewModel.ivaCinco" readonly>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label">
										IVA Diez
									</label>
									<div class="col-8">
										<input class="form-control m-input" type="text" id="productoCantidad" data-bind="value: dataViewModel.ivaDiez" readonly>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label">
										IVA Total
									</label>
									<div class="col-8">
										<input class="form-control m-input" type="text" id="productoCantidad" data-bind="value: dataViewModel.ivaTotal" readonly>
									</div>
								</div>
							</div>
						</div>

					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- /content -->
@section scripts{
	<script>
        var model = @Html.Raw(Json.Serialize(Model));
        var dataViewModel = ko.mapping.fromJS(model);

        dataViewModel.totalExcenta = ko.pureComputed(function () {
            var total = $.grep(dataViewModel.detalleCompra(), function (item) { return item.porcentajeIva() === 1; }).reduce(function (a, b) {
                return a + b.montoTotal();
            }, 0)
            return total;
        })

        dataViewModel.totalCinco = ko.pureComputed(function () {
            var total = $.grep(dataViewModel.detalleCompra(), function (item) { return item.porcentajeIva() === 2; }).reduce(function (a, b) {
                return a + b.montoTotal();
            }, 0)
            return total;
        })

        dataViewModel.totalDiez = ko.pureComputed(function () {
            var total = $.grep(dataViewModel.detalleCompra(), function (item) { return item.porcentajeIva() === 3; }).reduce(function (a, b) {
                ////if (a == 0) {
                ////    return b.montoTotal();
                ////} else {
                return a + b.montoTotal();
                //}
            }, 0)
            return total;
        })

        dataViewModel.ivaTotal = ko.pureComputed(function () {
            return dataViewModel.ivaCinco() + dataViewModel.ivaDiez();
        })

        dataViewModel.confirmarCompra = function(){
            confirmAction().then(function (result) {
				if (result.value) {
					  $.ajax({
                        url: "@Url.Action("Confirm")",
                        type: "POST",
                        data: { id: dataViewModel.id()},
                        success: function (response) {
                            if (response.success) {

                                 showSuccessAndGoToUrl(response.message, '@Url.Action("Index", "Compras", new { area = "Platform"})');
                            } else {
                                showError(response.message);
                            }
                        },
                        error: function () {
                            showError("Error!");
                        }
                    });
				}
			});
            return false;
        }
        ko.applyBindings(dataViewModel);
	</script>
}