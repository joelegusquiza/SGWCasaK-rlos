@model Core.DTOs.Recibos.RecibosAddViewModel
@using Core
<div class="m-content" style="width: 100%">
	<div class="row">
		<div class="col-md-12">
			<div class="m-portlet m-portlet--tab">
				<div class="m-portlet__head">
					<div class="row">
						<div class="col-md-6 col-sm-4">
							<div class="m-portlet__head-caption">
								<div class="m-portlet__head-title" style="margin-top: 20px;">
									<h3 class="m-portlet__head-text">
										Agregar Recibo
									</h3>
								</div>
							</div>
						</div>

						<div class="col-md-6 col-sm-4" align="right">
							<div class="m-portlet__head-title" style="margin-top: 20px;">
								<button type="button" class="m-demo__preview  m-demo__preview btn btn m-btn m-btn--gradient-from-primary m-btn--gradient-to-info" data-bind="click: postDataToController, enable: dataViewModel.cuotas().length > 0">
									Guardar
								</button>

							</div>
						</div>

					</div>
				</div>
				<!--begin::Form-->
				<form class="m-form m-form--fit m-form--label-align-right">
					<div class="m-portlet__body">
						<div class="row" style="margin-bottom: 20px;">
							<div class="col-md-6">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-2 col-form-label" style="text-align: left">
										Ruc
									</label>
									<div class="col-6">
										<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.cliente.ruc" readonly>
									</div>
									<div class="col-4" align="right">

										<button type="button" class="m-demo__preview  m-demo__preview btn btn m-btn m-btn--gradient-from-primary m-btn--gradient-to-info" onclick="showListaClientesModal()">
											Buscar
										</button>

									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label" style="text-align: left">
										Nombre o Razon Social
									</label>
									<div class="col-8">
										<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.cliente.displayName" readonly>
									</div>
								</div>
							</div>
						</div>
						<div class="row" style="margin-bottom: 20px;">
							<div class="col-md-6">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-2 col-form-label" style="text-align: left">
										Nro Factura
									</label>
									<div class="col-6">
										<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.venta.nroFacturaString" readonly>
									</div>
									<div class="col-4" align="right">

										<button type="button" class="m-demo__preview  m-demo__preview btn btn m-btn m-btn--gradient-from-primary m-btn--gradient-to-info" onclick="showListaVentaModal()" data-bind="enable: dataViewModel.cliente.clienteId() != 0">
											Buscar
										</button>

									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group m-form__group row">
									<label for="example-text-input" class="col-4 col-form-label" style="text-align: left">
										Monto Total
									</label>
									<div class="col-8">
										<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.venta.monto" readonly>
									</div>
								</div>
							</div>
						</div>

					</div>
					@*<div class="m-portlet__body">
			<div class="row" style="margin-bottom: 20px;">
				<div class="col-md-6">
					<div class="form-group m-form__group row">
						<label for="example-text-input" class="col-2 col-form-label" style="text-align: left">
							Ruc
						</label>
						<div class="col-6">
							<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.cliente.ruc">
						</div>
						<div class="col-4" align="right">

							<button type="button" class="btn btn-success" onclick="showListaClientesModal()">
								Buscar
							</button>

						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group m-form__group row">
						<label for="example-text-input" class="col-4 col-form-label" style="text-align: left">
							Nombre o Razon Social
						</label>
						<div class="col-8">
							<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.cliente.displayName">
						</div>
					</div>
				</div>

					<div class="col-md-12">
						<div class="form-group m-form__group row">
							<label for="example-text-input" class="col-2 col-form-label" style="text-align: left">
								Monto Venta
							</label>
							<div class="col-6">
								<input class="form-control m-input" type="text" id="example-text-input" data-bind="value: dataViewModel.venta.monto" readonly>
							</div>
							<div class="col-4" align="right">

								<button type="button" class="btn btn-success" onclick="showListaVentaModal()" data-bind="enable: dataViewModel.cliente.clienteId() != 0">
									Buscar
								</button>

							</div>
						</div>
					</div>


			</div>

		</div>*@

				</form>
			</div>
			<div class="m-portlet m-portlet--tab">
				<div class="m-portlet__head">
					<div class="row">
						<div class="col-md-6 col-sm-4">
							<div class="m-portlet__head-caption">
								<div class="m-portlet__head-title" style="margin-top: 20px;">
									<h3 class="m-portlet__head-text">
										Cuotas
									</h3>
								</div>
							</div>
						</div>

						<div class="col-md-6 col-sm-4" align="right">
							<div class="m-portlet__head-title" style="margin-top: 20px;">
								<button type="button" class="m-demo__preview  m-demo__preview btn btn m-btn m-btn--gradient-from-primary m-btn--gradient-to-info" onclick="showListaCuotasModal()" data-bind="enable: dataViewModel.venta.ventaId() != 0">
									Seleccionar
								</button>

							</div>
						</div>

					</div>
				</div>


				<div class="m-portlet__body">
					<!--begin: Datatable -->
					<table id="cuotasTable" class="table m-table m-table--head-bg-success">
						<thead>
							<tr>
								<th title="Field #1">
									Nro
								</th>
								<th title="Field #2">
									Vencimiento
								</th>
								<th title="Field #5">
									Monto
								</th>
								<th></th>
							</tr>
						</thead>
						<tbody data-bind="foreach: cuotas">
							<tr>
								<td data-bind="text: numeroCuota"></td>
								<td data-bind="text: moment(fechaVencimiento()).format('DD/MM/YYYY')"></td>
								<td data-bind="text: monto"></td>
								<td><a href="#" data-bind="attr: { id: cuotaId() }, click: $parent.eliminarDetalle"><i class="fa fa-trash"></i></a></td>
							</tr>

						</tbody>
						<tfoot>
							<tr>
								<td colspan="2" style="text-align : center">Monto Total </td>
								<td data-bind="text: montoTotal"></td>
							</tr>
						</tfoot>
					</table>
					<!--end: Datatable -->

				</div>
			</div>
		</div>
	</div>
</div>
@{
	Html.RenderPartial("~/Areas/Platform/Views/Shared/_ListaClientesModal.cshtml");
	Html.RenderPartial("~/Areas/Platform/Views/Shared/_ListaCuotasModal.cshtml");
	Html.RenderPartial("~/Areas/Platform/Views/Shared/_ListaVentasModal.cshtml");


}
<!-- /content -->
@section scripts{
	<script>
        var model = @Html.Raw(Json.Serialize(Model));
        var dataViewModel = ko.mapping.fromJS(model);


        dataViewModel.postDataToController = function () {
            $.ajax({
                url: "@Url.Action("Save", "Recibos")",
                type: "POST",
                data: { model: ko.toJSON(dataViewModel) },
                success: function (response) {
                    if (response.success) {
                        showSuccessAndGoToUrl(response.message, '@Url.Action("Index", "Recibos", new { area = "Platform"})');
                    } else {
                        showError(response.message);
                    }
                },
                error: function () {
                    showError();
                }
            });
            return false;
        }

		dataViewModel.eliminarDetalle = function () {
			var item = this;
			dataViewModel.cuotas.remove(item);
		}

		dataViewModel.montoTotal = ko.pureComputed(function () {
			var total = dataViewModel.cuotas().reduce(function (a, b) {

				return a + b.monto();

			}, 0)
			return total;
		})

		

		ko.applyBindings(dataViewModel);

        $(document).ready(function () {
            $('#form').validate({
                rules: {
                    estado: {
                        required: true
                    },
                },
                errorPlacement: function (error, element) {
                    var span = element.siblings('span');
                    error.appendTo(span);
                }
            });
        })
		 function showListaClientesModal() {
           $("#listaClientesModalIframe").attr('src', '@Url.Action("ListaClientes", "Clientes", new { area = "Platform"})');
           $("#listaClientesModal").modal("show");
        }

		function seleccionarCliente(cliente) {
			ko.mapping.fromJS(cliente, {}, dataViewModel.cliente);
            $("#listaClientesModal").modal("hide");
		}

		function showListaCuotasModal() {
			$("#listaCuotasIframe").attr('src', '@Url.Action("ListaCuotasVenta", "Cuotas", new { area = "Platform"})?ventaId=' + dataViewModel.venta.ventaId());
			$("#listaCuotasModal").modal("show");
		}

		function showListaVentaModal() {
			$("#listaVentasModalIframe").attr('src', '@Url.Action("ListaVentasByClienteId", "Ventas", new { area = "Platform"})?clienteId='+ dataViewModel.cliente.clienteId());
			$("#listaVentasModal").modal("show");
        }

        function seleccionarVenta(venta) {
			$("#listaVentasModal").modal("hide");
            ko.mapping.fromJS(venta, {}, dataViewModel.venta);
        }

		function seleccionarCuotas(cuotas)
		{
			for (var i = 0; i < cuotas.length; i++)
			{
				var item = { cuotaId: ko.observable(cuotas[i].cuotaId), monto: ko.observable(cuotas[i].monto), fechaVencimiento: ko.observable(cuotas[i].fechaVencimiento), numeroCuota: ko.observable(cuotas[i].numeroCuota) }
				dataViewModel.cuotas.push(ko.mapping.fromJS(ko.toJS(item)));
			}


			//dataViewModel.cuotas = ko.mapping.fromJS(cuotas);
			//dataViewModel.cuotas([])
			$("#listaCuotasModal").modal("hide");
		}

		
       
	</script>
}